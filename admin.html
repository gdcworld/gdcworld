<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Admin â€“ GDC World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- íŒŒë¹„ì½˜ (ìƒëŒ€ê²½ë¡œ) -->
  <link rel="icon" href="./favicon.png?v=3" type="image/png">

  <!-- í†¤ ìœ ì§€ -->
  <style>
    :root{ --gold:#e3c08b; --gold-2:#c4976b; --card:#3a3b41; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--gold), var(--gold-2) 60%, #8a674f);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:#fff;
    }
  </style>

  <!-- ê³µí†µ CSS -->
  <link rel="stylesheet" href="assets/common.css">


  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="assets/auth.js?v=1" defer></script>
  <script src="assets/app.js?v=1" defer></script>
</head>
<body>
  <!-- ë ˆì´ì•„ì›ƒ: ì‚¬ì´ë“œë°” + ë©”ì¸ -->
  <div class="layout">
    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <div class="brandRow">
        <img src="./gdc_logo.svg?v=1" alt="logo" style="width:28px;height:28px;">
        <div>GDC World (Admin)</div>
      </div>
      <nav class="nav">
        <!-- â–¼ ë¹„ê¸‰ì—¬ì¹˜ë£Œ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-noncovered" aria-expanded="false">
            <span class="left">ğŸ–ï¸ ë¹„ê¸‰ì—¬ì¹˜ë£Œ</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-noncovered">
            <button class="subitem" data-view="noncovered-dosu">ë„ìˆ˜ ì¹˜ë£Œ</button>
            <button class="subitem" data-view="noncovered-shock">ì¶©ê²©íŒŒ</button>
            <button class="subitem" data-view="noncovered-dosu-note">ë„ìˆ˜ì¹˜ë£Œ ìƒë‹´ì¼ì§€</button>
            <button class="subitem" data-view="noncovered-shock-note">ì¶©ê²©íŒŒ ìƒë‹´ì¼ì§€</button>
            <button class="subitem" data-view="noncovered-chart">í™˜ì ì°¨íŠ¸</button>
          </div>
        </div>

        <!-- â–¼ ì†Œëª¨í’ˆ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-consumables" aria-expanded="false">
            <span class="left">ğŸ’¼ ì†Œëª¨í’ˆ</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-consumables">
            <button class="subitem" data-view="consumables-main">ì†Œëª¨í’ˆ</button>
            <button class="subitem" data-view="consumables-stock">ì†Œëª¨í’ˆ (ì¬ê³ ê´€ë¦¬)</button>
            <button class="subitem" data-view="consumables-balance">ì†Œëª¨í’ˆ (ì”ê³ í˜„í™©)</button>
            <button class="subitem" data-view="consumables-byvendor">ì†Œëª¨í’ˆ (ê±°ë˜ì²˜ë³„)</button>
          </div>
        </div>

        <!-- â–¼ ì˜ì•½í’ˆ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-drugs" aria-expanded="false">
            <span class="left">ğŸ’Š ì˜ì•½í’ˆ</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-drugs">
            <button class="subitem" data-view="drugs-main">ì˜ì•½í’ˆ</button>
            <button class="subitem" data-view="drugs-stock">ì˜ì•½í’ˆ (ì¬ê³ ê´€ë¦¬)</button>
            <button class="subitem" data-view="drugs-balance">ì˜ì•½í’ˆ (ì”ê³ í˜„í™©)</button>
            <button class="subitem" data-view="drugs-byvendor">ì˜ì•½í’ˆ (ê±°ë˜ì²˜ë³„)</button>
          </div>
        </div>

        <!-- â–¼ ê³„ì •ê´€ë¦¬ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-accounts" aria-expanded="false">
            <span class="left">ğŸ‘¤ ê³„ì •ê´€ë¦¬</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-accounts">
            <button class="subitem" data-view="accounts-physio">ë¬¼ë¦¬ì¹˜ë£Œì‚¬</button>
            <button class="subitem" data-view="accounts-ptadmin">PTê´€ë¦¬ì</button>
            <button class="subitem" data-view="accounts-nurse">ê°„í˜¸ì‚¬</button>
            <button class="subitem" data-view="accounts-frontdesk">ì›ë¬´</button>
            <button class="subitem" data-view="accounts-radiology">ë°©ì‚¬ì„ ì‚¬</button>
            <button class="subitem" data-view="accounts-vice">ë¶€ì›ì¥</button>
          </div>
        </div>

        <!-- ë‚˜ë¨¸ì§€ ìƒìœ„ ë©”ë‰´ (ë‹¨ì¼ ë²„íŠ¼) -->
        <button data-view="income"><span class="left">ğŸ“ˆ ìˆ˜ì…/ì§€ì¶œ</span>â€º</button>
        <button data-view="nhis"><span class="left">ğŸ“‹ ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©</span>â€º</button>
        <button data-view="revisit"><span class="left">ğŸ“Š ì¬ì§„ìœ¨</span>â€º</button>
        <button data-view="claims"><span class="left">ğŸ§¾ ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­</span>â€º</button>
        <button data-view="closing"><span class="left">ğŸ“ ë§ˆê°ì¼ì§€</span>â€º</button>
        <button data-view="categories"><span class="left">ğŸ—‚ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</span>â€º</button>
        <button data-view="partners"><span class="left">ğŸ¥ ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ)</span>â€º</button>
        <button data-view="carm"><span class="left">ğŸ“· C-arm</span>â€º</button>
      </nav>
    </aside>

    <!-- ë©”ì¸ -->
    <main class="main">
      <div class="headerBar">
        <h1 class="h1" id="pageTitle">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <div>
          <span id="whoami" style="opacity:.85;font-size:14px;margin-right:8px;"></span>
          <button class="btn" id="logoutBtn" type="button">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ) -->
      <section class="panel hidden" data-panel="partners" id="partnersBox">
        <h2 class="h1">ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ) ë§¤ì¶œ</h2>
        <div class="tools">
          <label>ë³‘ì› ì„ íƒ:
            <select id="hospitalSelect"></select>
          </label>
          <span id="hospitalMeta" style="opacity:.85;"></span>
          <button class="btn" id="exportCsv" type="button">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <table class="table" id="hospitalTable">
          <thead><tr><th>ì›”</th><th>ë§¤ì¶œ</th><th>ì²­êµ¬ê±´ìˆ˜</th><th>ë¹„ê³ </th></tr></thead>
          <tbody><tr><td colspan="4">ë¡œë”© ì¤‘â€¦</td></tr></tbody>
        </table>
      </section>

      <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ -->
      <section class="panel hidden" data-panel="categories" id="categoriesBox">
        <h2 class="h1">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2>
        <div class="tools" style="gap:8px; flex-wrap:wrap;">
          <label>ë©”ë‰´ ì„ íƒ:
            <select id="categoryModuleSelect">
              <option value="noncovered">ë¹„ê¸‰ì—¬ì¹˜ë£Œ</option>
              <option value="consumables">ì†Œëª¨í’ˆ</option>
              <option value="drugs">ì˜ì•½í’ˆ</option>
              <option value="income">ìˆ˜ì…/ì§€ì¶œ</option>
              <option value="nhis">ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©</option>
              <option value="revisit">ì¬ì§„ìœ¨</option>
              <option value="claims">ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­</option>
              <option value="closing">ë§ˆê°ì¼ì§€</option>
              <option value="accounts">ê³„ì •ê´€ë¦¬</option>
              <option value="partners">ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ)</option>
            </select>
          </label>

          <input id="catNameInput" type="text" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì…ë ¥"
                 style="padding:8px 10px;border-radius:8px;border:1px solid #444;background:#202227;color:#fff;min-width:220px;">
          <button class="btn" id="addCatBtn"    type="button">ì¶”ê°€</button>
          <button class="btn" id="renameCatBtn" type="button">ì´ë¦„ ë³€ê²½</button>
          <button class="btn" id="deleteCatBtn" type="button">ì‚­ì œ</button>

          <button class="btn" id="exportCatBtn" type="button">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          <label class="btn" style="cursor:pointer;">
            ê°€ì ¸ì˜¤ê¸°(JSON)
            <input id="importCatInput" type="file" accept="application/json" style="display:none;">
          </label>
        </div>

        <table class="table" id="categoryTable">
          <thead><tr><th style="width:56px;">#</th><th>ì¹´í…Œê³ ë¦¬ëª…</th></tr></thead>
          <tbody><tr><td colspan="2">ë¡œë”© ì¤‘â€¦</td></tr></tbody>
        </table>

        <p class="muted" style="margin-top:8px;">
          ì €ì¥: ë¸Œë¼ìš°ì € ë¡œì»¬ìŠ¤í† ë¦¬ì§€. ì´ˆê¸°ê°’ì€ <code>assets/data/categories.json</code>ì—ì„œ 1íšŒ ë¡œë“œë©ë‹ˆë‹¤.
        </p>
      </section>

      <!-- â–¼ ë¹„ê¸‰ì—¬ì¹˜ë£Œ í•˜ìœ„ íŒ¨ë„ -->
      <section class="panel hidden" data-panel="noncovered-dosu"><h2 class="h1">ë„ìˆ˜ ì¹˜ë£Œ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="noncovered-shock"><h2 class="h1">ì¶©ê²©íŒŒ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="noncovered-dosu-note"><h2 class="h1">ë„ìˆ˜ì¹˜ë£Œ ìƒë‹´ì¼ì§€</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="noncovered-shock-note"><h2 class="h1">ì¶©ê²©íŒŒ ìƒë‹´ì¼ì§€</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="noncovered-chart"><h2 class="h1">í™˜ì ì°¨íŠ¸</h2>ì¤€ë¹„ ì¤‘</section>

      <!-- â–¼ ì†Œëª¨í’ˆ í•˜ìœ„ íŒ¨ë„ -->
      <section class="panel hidden" data-panel="consumables-main"><h2 class="h1">ì†Œëª¨í’ˆ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="consumables-stock"><h2 class="h1">ì†Œëª¨í’ˆ (ì¬ê³ ê´€ë¦¬)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="consumables-balance"><h2 class="h1">ì†Œëª¨í’ˆ (ì”ê³ í˜„í™©)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="consumables-byvendor"><h2 class="h1">ì†Œëª¨í’ˆ (ê±°ë˜ì²˜ë³„)</h2>ì¤€ë¹„ ì¤‘</section>

      <!-- â–¼ ì˜ì•½í’ˆ í•˜ìœ„ íŒ¨ë„ -->
      <section class="panel hidden" data-panel="drugs-main"><h2 class="h1">ì˜ì•½í’ˆ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="drugs-stock"><h2 class="h1">ì˜ì•½í’ˆ (ì¬ê³ ê´€ë¦¬)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="drugs-balance"><h2 class="h1">ì˜ì•½í’ˆ (ì”ê³ í˜„í™©)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="drugs-byvendor"><h2 class="h1">ì˜ì•½í’ˆ (ê±°ë˜ì²˜ë³„)</h2>ì¤€ë¹„ ì¤‘</section>

      <!-- â–¼ ê³„ì •ê´€ë¦¬ í•˜ìœ„ íŒ¨ë„ (account-module) -->
      <section class="panel hidden" data-panel="accounts-physio">
        <h2 class="h1">ë¬¼ë¦¬ì¹˜ë£Œì‚¬</h2>
        <div class="account-module" data-role="physio"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-ptadmin">
        <h2 class="h1">PTê´€ë¦¬ì</h2>
        <div class="account-module" data-role="ptadmin"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-nurse">
        <h2 class="h1">ê°„í˜¸ì‚¬</h2>
        <div class="account-module" data-role="nurse"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-frontdesk">
        <h2 class="h1">ì›ë¬´</h2>
        <div class="account-module" data-role="frontdesk"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-radiology">
        <h2 class="h1">ë°©ì‚¬ì„ ì‚¬</h2>
        <div class="account-module" data-role="radiology"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-vice">
        <h2 class="h1">ë¶€ì›ì¥</h2>
        <div class="account-module" data-role="vice"></div>
      </section>

   <!-- C-arm ì›”ê°„ ëŒ€ì‹œë³´ë“œ -->
<section class="panel hidden" data-panel="carm">
  <h2 class="h1">C-arm ì›”ê°„ ëŒ€ì‹œë³´ë“œ</h2>

  <div class="tools" style="display:flex; gap:8px; margin-bottom:12px; align-items:center; flex-wrap:wrap;">
    <input id="carmMonth" type="month"
      style="padding:8px 10px;border-radius:8px;border:1px solid #444;background:#202227;color:#fff;">
    <button class="btn" id="carmMonthPrev" type="button">ì´ì „</button>
    <button class="btn" id="carmMonthNext" type="button">ë‹¤ìŒ</button>
    <button class="btn" id="carmMonthLoad" type="button">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <!-- ë‹¬ë ¥í˜• 7ì—´ ë³´ë“œ -->
  <div id="carmBoard"
   style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px;">
     <!-- JSì—ì„œ ì¼ì ì¹´ë“œ ìƒì„± -->
  </div>
</section>


      <!-- ê¸°ì¡´ ë‹¨ì¼ íŒ¨ë„ -->
      <section class="panel hidden" data-panel="income"><h2 class="h1">ìˆ˜ì…/ì§€ì¶œ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="nhis"><h2 class="h1">ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="revisit"><h2 class="h1">ì¬ì§„ìœ¨</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="claims"><h2 class="h1">ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="closing"><h2 class="h1">ë§ˆê°ì¼ì§€</h2>ì¤€ë¹„ ì¤‘</section>
    </main>
  </div>

  <!-- ì¸ì¦/ë¡œê·¸ì•„ì›ƒ/ë„¤ë¹„ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
document.addEventListener('DOMContentLoaded', function(){
  if (!window.Auth) { alert('auth.js ë¡œë“œ ì‹¤íŒ¨'); return; }
  Auth.requireRole();

  // ë¹„ê´€ë¦¬ì í—¤ë” ìˆ¨ê¹€
  const role = ((window.Auth && Auth.currentRole && Auth.currentRole()) || 'member').toLowerCase();
  if (role !== 'admin') document.getElementById('pageTitle')?.classList.add('hidden');

  const emailEl = document.getElementById('whoami');
  if (emailEl) emailEl.textContent = Auth.currentUserEmail() || '';
  document.getElementById('logoutBtn')?.addEventListener('click', ()=>{ Auth.logout(); location.replace('index.html'); });

  // â”€ ì—­í•  ì ‘ê·¼í‘œ â”€
  const VIEW_ACCESS = {
    admin:'ALL',
    frontdesk:['income','closing'],
    nurse:['consumables-*','drugs-*'],
    physio:['noncovered-*'],
    ptadmin:[], radiology:['carm'], vice:[], staff:[], member:[]
  };

  function matchesAny(id, patterns){
    return patterns.some(p=>{
      if (p === '*') return true;
      if (p.endsWith('*')) return id.startsWith(p.slice(0,-1));
      return p === id;
    });
  }

  // â–¼ allow/allowAllì„ ì´ í•¨ìˆ˜ "ì•ˆì—ì„œ"ë§Œ ì‚¬ìš©
  function applyRoleVisibility(roleStr){
    const allow = (roleStr in VIEW_ACCESS) ? VIEW_ACCESS[roleStr] : [];
    const allowAll = allow === 'ALL';

    // ë²„íŠ¼ í† ê¸€
    document.querySelectorAll('.nav [data-view]').forEach(btn=>{
      const v = btn.dataset.view;
      const ok = allowAll || matchesAny(v, allow);
      btn.classList.toggle('hidden', !ok);
    });

    // íŒ¨ë„ í† ê¸€
    document.querySelectorAll('[data-panel]').forEach(p=>{
      const id = p.dataset.panel;
      const ok = allowAll || matchesAny(id, allow);
      p.classList.toggle('hidden', !ok);
    });
     
  if (roleStr !== 'admin') {
    document.querySelector('[data-view="partners"]')?.classList.add('hidden');
    document.querySelector('[data-panel="partners"]')?.classList.add('hidden');
  }

    // ë¹„ì–´ìˆëŠ” ê·¸ë£¹ ê°ì¶”ê¸°
    document.querySelectorAll('.nav-group').forEach(grp=>{
      const subs = grp.querySelectorAll('.subitem[data-view]');
      if (subs.length){
        const anyVisible = Array.from(subs).some(s=>!s.classList.contains('hidden'));
        grp.classList.toggle('hidden', !anyVisible);
      }
    });

    // ì²« í—ˆìš© ë©”ë‰´ë¡œ ì§„ì…(ìˆì„ ë•Œë§Œ)
    const prefer    = document.querySelector('.nav [data-view="carm"]:not(.hidden)');
    const firstBtn  = prefer || document.querySelector('.nav [data-view]:not(.hidden)');
     const firstView = firstBtn ? firstBtn.dataset.view : null;
    if (firstView && typeof showPanel === 'function') showPanel(firstView);
    else document.querySelectorAll('[data-panel]').forEach(p => p.classList.add('hidden'));
  }

  // ì‚¬ì´ë“œë°” í† ê¸€/í´ë¦­
  document.querySelectorAll('.nav-parent').forEach(parent=>{
    const targetSel = parent.getAttribute('data-collapse-target');
    const box = targetSel ? document.querySelector(targetSel) : null;
    parent.addEventListener('click', ()=>{
      const open = parent.getAttribute('aria-expanded') === 'true';
      parent.setAttribute('aria-expanded', String(!open));
      if (box) box.classList.toggle('open', !open);
    });
  });
  document.querySelectorAll('.nav [data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=> showPanel(btn.dataset.view));
  });

  // íŒ¨ë„ ì „í™˜
  const titleMap = {
    'noncovered-dosu':'ë„ìˆ˜ ì¹˜ë£Œ', 'noncovered-shock':'ì¶©ê²©íŒŒ',
    'noncovered-dosu-note':'ë„ìˆ˜ì¹˜ë£Œ ìƒë‹´ì¼ì§€', 'noncovered-shock-note':'ì¶©ê²©íŒŒ ìƒë‹´ì¼ì§€',
    'noncovered-chart':'í™˜ì ì°¨íŠ¸',
    'consumables-main':'ì†Œëª¨í’ˆ','consumables-stock':'ì†Œëª¨í’ˆ (ì¬ê³ ê´€ë¦¬)',
    'consumables-balance':'ì†Œëª¨í’ˆ (ì”ê³ í˜„í™©)','consumables-byvendor':'ì†Œëª¨í’ˆ (ê±°ë˜ì²˜ë³„)',
    'drugs-main':'ì˜ì•½í’ˆ','drugs-stock':'ì˜ì•½í’ˆ (ì¬ê³ ê´€ë¦¬)','drugs-balance':'ì˜ì•½í’ˆ (ì”ê³ í˜„í™©)','drugs-byvendor':'ì˜ì•½í’ˆ (ê±°ë˜ì²˜ë³„)',
    'accounts-physio':'ë¬¼ë¦¬ì¹˜ë£Œì‚¬','accounts-ptadmin':'PTê´€ë¦¬ì','accounts-nurse':'ê°„í˜¸ì‚¬',
    'accounts-frontdesk':'ì›ë¬´','accounts-radiology':'ë°©ì‚¬ì„ ì‚¬','accounts-vice':'ë¶€ì›ì¥',
    'partners':'ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ)','categories':'ì¹´í…Œê³ ë¦¬ ê´€ë¦¬',
    'income':'ìˆ˜ì…/ì§€ì¶œ','nhis':'ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©','revisit':'ì¬ì§„ìœ¨','claims':'ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­','closing':'ë§ˆê°ì¼ì§€',
    'carm':'C-arm'
  };
  window.showPanel = function(id){
   const roleNow = (window.Auth?.currentRole?.() || 'member').toLowerCase();
  if (id === 'partners' && roleNow !== 'admin') {
    const prefer = document.querySelector('.nav [data-view="carm"]:not(.hidden)');
    const fb = prefer || document.querySelector('.nav [data-view]:not(.hidden)');
    if (!fb) { document.querySelectorAll('[data-panel]').forEach(p=>p.classList.add('hidden')); return; }
    id = fb.dataset.view; // radiologyë©´ C-arm, ê·¸ ì™¸ì—” ê°ì ì²« ë©”ë‰´
  }
    document.querySelectorAll('[data-panel]').forEach(p=>{
      p.classList.toggle('hidden', p.getAttribute('data-panel') !== id);
    });
    const h = document.getElementById('pageTitle');
    if (h) h.textContent = titleMap[id] || h.textContent;
    document.querySelectorAll('.subitem').forEach(b=>{
      b.classList.toggle('active', b.dataset.view === id);
    });
    if (window.__bootAccountsModules) {
      const panelEl = document.querySelector(`[data-panel="${id}"]`);
     window.__bootAccountsModules(panelEl);
    }
      if (id === 'carm' && window.initCarmMonth) window.initCarmMonth();
  };

  // â˜† ë§ˆì§€ë§‰ì— í•œ ë²ˆë§Œ í˜¸ì¶œ
  applyRoleVisibility(role);
});
</script>

  <!-- ê³„ì •ê´€ë¦¬ í…Œì´ë¸” ëª¨ë“ˆ -->
  <script src="assets/accounts.js?v=3" defer></script>

  <!-- ê³„ì • ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="account-modal" class="modal hidden">
    <div class="modal-card">
      <h3 id="account-modal-title">ê³„ì • ìƒì„±</h3>
      <form id="account-form">
        <div class="grid">
          <label>ë¡œê·¸ì¸ ID
            <input name="loginId" type="text" required placeholder="physio_user1" />
          </label>
          <label>ë¹„ë°€ë²ˆí˜¸
            <div style="display:flex;align-items:center;gap:6px;">
              <input name="password" type="password" placeholder="ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸" style="flex:1;" />
              <button type="button" class="btn ghost toggle-pass" data-target="password">ë³´ê¸°</button>
            </div>
          </label>

          <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            <div style="display:flex;align-items:center;gap:6px;">
              <input name="password2" type="password" placeholder="ë‹¤ì‹œ ì…ë ¥" style="flex:1;" />
              <button type="button" class="btn ghost toggle-pass" data-target="password2">ë³´ê¸°</button>
            </div>
          </label>

          <label>ì´ë¦„
            <input name="name" type="text" required placeholder="í™ê¸¸ë™" />
          </label>
          <label>ì´ë©”ì¼
            <input name="email" type="email" placeholder="user@example.com" />
          </label>
          <label>ì „í™”ë²ˆí˜¸
            <input name="phone" type="tel" placeholder="010-1234-5678" />
          </label>
          <label>ìƒíƒœ
            <select name="status" required>
              <option value="active">í™œì„±</option>
              <option value="inactive">ë¹„í™œì„±</option>
            </select>
          </label>

          <!-- â–¼ ê¶Œí•œ(ì—­í• ) ì„ íƒ -->
          <label>ê¶Œí•œ(ì—­í• )
            <select name="role" required>
              <option value="physio">ë¬¼ë¦¬ì¹˜ë£Œì‚¬</option>
              <option value="ptadmin">PTê´€ë¦¬ì</option>
              <option value="nurse">ê°„í˜¸ì‚¬</option>
              <option value="frontdesk">ì›ë¬´</option>
              <option value="radiology">ë°©ì‚¬ì„ ì‚¬</option>
              <option value="vice">ë¶€ì›ì¥</option>
              <option value="staff">ìŠ¤íƒœí”„</option>
              <option value="member">ë©¤ë²„</option>
              <option value="admin">ê´€ë¦¬ì</option>
            </select>
          </label>
        </div>

        <!-- ì—­í• ë³„ ì¶”ê°€ í•„ë“œ ë™ì  ì£¼ì… ì˜ì—­ -->
        <div class="grid" id="extra-fields" style="margin-top:10px;"></div>

        <div class="row right">
          <button type="button" class="btn ghost" id="account-cancel">ì·¨ì†Œ</button>
          <button type="submit" class="btn primary" id="account-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ê°„ë‹¨ í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast hidden"></div>

  <style>
    .hidden{display:none}
    .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:1000}
    .modal-card{width:min(620px, 92vw); background:#2b2d33; color:#fff; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .modal-card h3{margin:0 0 12px}
    .modal-card .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .modal-card label{display:flex; flex-direction:column; gap:6px; font-size:14px}
    .modal-card input, .modal-card select{
      padding:10px 12px; border:1px solid #444; border-radius:10px; background:#1f2025; color:#fff; outline:none
    }
    .row.right{display:flex; gap:8px; justify-content:flex-end; margin-top:14px}
    .btn{padding:10px 14px; border-radius:10px; border:1px solid transparent; background:#3a3b41; color:#fff; cursor:pointer}
    .btn.primary{background:var(--gold-2)}
    .btn.ghost{background:transparent; border-color:#555}
    .toast{position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
           background:#1f2025; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #444; z-index:1100}
  </style>

  <script>
    // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".toggle-pass");
      if (!btn) return;
      let scope = btn.closest("label, .row, .field, div");
      let input = scope?.querySelector(`input[name="${btn.dataset.target || ""}"]`);
      if (!input) input = scope?.querySelector('input[type="password"], input[type="text"]');
      if (!input) return;
      input.type = (input.type === "password") ? "text" : "password";
      btn.textContent = (input.type === "password") ? "ë³´ê¸°" : "ìˆ¨ê¸°ê¸°";
    });
  </script>

<script>
/* C-arm í¼ ì•ˆì—ì„œ Enter, Ctrl+S/âŒ˜S â†’ ì €ì¥ */
window.handleCarmHotkeys = function (e) {
  const form = e.target && e.target.closest && e.target.closest('form.carm-inline');
  if (!form) return;

  // Ctrl+S / Cmd+S
  if ((e.key === 's' || e.key === 'S') && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    form.requestSubmit();
    return false;
  }

  // Enter (Shift+EnterëŠ” ì œì™¸)
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    form.requestSubmit();
    return false;
  }
};
</script>

<script>
(function(){
  // API í˜¸ì¶œ: /api ìš°ì„ , ì‹¤íŒ¨ ì‹œ /.netlify/functions í´ë°±
  async function carmApi(path, opts = {}){
  const token = (window.Auth?.currentToken && Auth.currentToken()) || null;
  const defaultHeaders = {
    'Content-Type': 'application/json',
    ...(token ? { Authorization: `Bearer ${token}` } : {})
  };
  const init = {
    // ê¸°ë³¸ê°’ì€ GET, í˜¸ì¶œë¶€ì—ì„œ method ì§€ì • ê°€ëŠ¥
    method: opts.method || 'GET',
    body: opts.body,
    headers: { ...defaultHeaders, ...(opts.headers || {}) }
  };

  let r = await fetch('/api' + path, init);
  if (!r.ok) r = await fetch('/.netlify/functions/api' + path, init);

  let j = null;
  try { j = await r.json(); } catch {}
  if (!r.ok || j?.ok === false) throw new Error(j?.message || 'request_failed');
  return j;
}

  const fmtMonth = (d)=> d.toISOString().slice(0,7);

// âœ… (ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨, í•¨ìˆ˜ ë°”ê¹¥)
const getRole  = () => ((window.Auth?.currentRole && Auth.currentRole()) || 'member').toLowerCase();
const getEmail = () => (window.Auth?.currentUserEmail && Auth.currentUserEmail()) || '';

let __carmUsers = null;
async function loadCarmUsers(){
  if (__carmUsers) return __carmUsers;

  const token = (window.Auth?.currentToken && Auth.currentToken()) || null;
  const headers = token ? { Authorization: `Bearer ${token}` } : {};
  const r = await fetch('/api/carm/users', { headers });
  const j = await r.json().catch(()=>({}));

  const admins = (j.admins || []).map(u => ({ id:u.id, name:u.name || 'ê´€ë¦¬ì' }));
  const radios = (j.radiology || []).map(u => ({ id:u.id, name:u.name || 'ë¬´ëª…' }));
  __carmUsers = [...admins, ...radios];     // ê´€ë¦¬ì ìš°ì„ , ë‹¤ìŒ ë°©ì‚¬ì„ ì‚¬
  return __carmUsers;
}


// âœ… (ê¸°ì¡´ dayCardëŠ” ì‚­ì œí•˜ê³ , ì´ ë²„ì „ë§Œ ë‚¨ê¸°ê¸°)
function dayCard(dayLabel, items, ymd, canEdit){
  const totalC = items.reduce((s,x)=> s + (x.carm||0), 0);
  const totalA = items.reduce((s,x)=> s + (x.arthro||0), 0);
  const role = (window.Auth && Auth.currentRole && Auth.currentRole()) || null;

  /* â‘  ì´ë¦„ ì…€ë ‰íŠ¸: ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ ìµœëŒ€í­ â†“ (280 â†’ 140), ì¤„ë°”ê¿ˆ ë°©ì§€ */
  const adminSelectHTML = (role === 'admin' || role === 'radiology')
    ? `<select name="who" class="rad-select"
       style="height:36px;padding:6px 10px;border-radius:8px;border:1px solid #444;
              background:#1f2025;color:#fff; width:auto; max-width:140px; flex:0 0 auto; white-space:nowrap;"></select>`
  : '';

  return `
    <div class="panel" style="padding:10px;">
      <div style="display:inline-block;white-space:nowrap;background:var(--gold);color:#111;
                  font-weight:700;font-size:13px;padding:4px 10px;border-radius:6px;margin-bottom:6px;">
        ${dayLabel}
      </div>

      ${canEdit ? `
      <form class="carm-inline" data-date="${ymd}" onkeydown="return handleCarmHotkeys(event)"
       style="margin-top:6px; display:grid; gap:8px;">
        <!-- â‘¡ 1í–‰: ì¤„ë°”ê¿ˆ ê¸ˆì§€(flex-wrap:nowrap)ë¡œ 'ê´€ì ˆê²½'ì´ C-arm ì˜†ì— ë¶™ë„ë¡ -->
        <div style="display:flex; align-items:center; gap:6px; flex-wrap:nowrap;">
          ${adminSelectHTML}
          <input name="carm"   type="number" min="0" placeholder="C-arm"
                 style="height:36px;width:60px;text-align:center;
                        padding:6px 10px;border-radius:8px;border:1px solid #444;
                        background:#1f2025;color:#fff;">
          <input name="arthro" type="number" min="0" placeholder="ê´€ì ˆê²½"
                 style="height:36px;width:60px;text-align:center;
                        padding:6px 10px;border-radius:8px;border:1px solid #444;
                        background:#1f2025;color:#fff;">
        </div>

        <!-- 2í–‰: total + ì €ì¥ + ìˆ˜ì • (ë²„íŠ¼ í¬ê¸° ë™ì¼) -->
<div style="display:flex; align-items:center; gap:8px;">
  <div style="font-weight:800;">total ${totalC}/${totalA}</div>
  <button class="btn" type="submit" style="height:36px; padding:6px 14px;">ì €ì¥</button>
  <button class="btn" type="button"
          onclick="this.closest('form').requestSubmit()"
          style="height:36px; padding:6px 14px;">ìˆ˜ì •</button>
</div>

      </form>
      ` : ``}
    </div>
  `;
}

 async function renderCarmBoard(monthStr){
  const grid = document.getElementById('carmBoard');
  if (!grid) return;
  grid.innerHTML = `<div class="panel" style="grid-column:1/-1;padding:12px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;

  // ì•ˆì „í•˜ê²Œ í˜¸ì¶œ (ê¶Œí•œ ì—ëŸ¬ ë“± í‘œì‹œ)
  let j;
  try {
   j = await carmApi(`/carm/summary?month=${encodeURIComponent(monthStr)}&_=${Date.now()}`);
  } catch (e) {
    grid.innerHTML = `<div class="panel" style="grid-column:1/-1;padding:12px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e?.message || e}</div>`;
    return;
  }

  const users = j.users || [];
  const rows  = j.rows  || [];

  const role = getRole();
const canEdit = ['admin', 'radiology'].includes(role);

  grid.innerHTML = rows.map(row=>{
    const items = users.map(u => ({
      name: u,
      carm:   Number(row[`${u}__carm`]   || 0),
      arthro: Number(row[`${u}__arthro`]|| 0),
    }));
    const mm  = Number(monthStr.slice(5,7));
    const dd  = String(row.day).padStart(2,'0');
    const ymd = `${monthStr}-${dd}`;
    const dayLabel = `${mm}ì›” ${row.day}ì¼`;
    return dayCard(dayLabel, items, ymd, canEdit);
}).join('');


 const roleNow = getRole();

try {
  const r = await fetch('/api/carm/users', {
    headers: {
      'Content-Type': 'application/json',
      ...(window.Auth?.currentToken?.() ? { Authorization: `Bearer ${Auth.currentToken()}` } : {})
    }
  });
  const j = await r.json();
  const admins = (j.admins || []).map(x => ({ id: x.id, name: x.name || 'ê´€ë¦¬ì' }));
  const radios  = (j.radiology || []).map(x => ({ id: x.id, name: x.name || 'ë¬´ëª…' }));

  const optsHTML = [...admins, ...radios]
    .map(u => `<option value="${u.id}">${u.name}</option>`)
    .join('');

  document.querySelectorAll('.rad-select').forEach(sel => {
    sel.innerHTML = optsHTML;
  });
} catch (e) {
  console.warn('carm/users load failed:', e);
}
}

  function initCarmMonth(){
  const panel = document.querySelector('[data-panel="carm"]');
  if (panel?.dataset.inited === '1') return;   // â† ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ì¬ì‹¤í–‰ X
  if (panel) panel.dataset.inited = '1';

  const mEl = document.getElementById('carmMonth');
  if (!mEl) return;
  if (!mEl.value) mEl.value = fmtMonth(new Date());

  const load = () => {
    const v = mEl.value;
    if (v) renderCarmBoard(v).catch(e => alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message));
  };

    document.getElementById('carmMonthLoad')?.addEventListener('click', load);
    document.getElementById('carmMonthPrev')?.addEventListener('click', ()=>{
      const d = new Date((mEl.value || fmtMonth(new Date())) + '-01');
      d.setMonth(d.getMonth() - 1);
      mEl.value = fmtMonth(d);
      load();
    });
    document.getElementById('carmMonthNext')?.addEventListener('click', ()=>{
      const d = new Date((mEl.value || fmtMonth(new Date())) + '-01');
      d.setMonth(d.getMonth() + 1);
      mEl.value = fmtMonth(d);
      load();
    });

    // ì²« ë¡œë“œ
    load();
  }
window.initCarmMonth = initCarmMonth;
  // C-arm íƒ­ ì§„ì… ì‹œì—ë§Œ ë¶€íŒ…
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.nav [data-view="carm"]');
    if (btn) initCarmMonth();
  });

  // ë§Œì•½ í˜„ì¬ íƒ­ì´ ì´ë¯¸ C-armì´ë¼ë©´ ì¦‰ì‹œ ë¶€íŒ…
  const carmPanel = document.querySelector('[data-panel="carm"]');
  if (carmPanel && !carmPanel.classList.contains('hidden')) {
    initCarmMonth();
  }
})();

document.addEventListener('submit', async (e)=>{
  const form = e.target.closest('.carm-inline');
  if (!form) return;
  e.preventDefault();

  const date   = form.dataset.date;                               // YYYY-MM-DD
  const carm   = Math.max(0, parseInt(form.carm?.value   || '0', 10));
  const arthro = Math.max(0, parseInt(form.arthro?.value || '0', 10));
  const createdBy = (getRole() === 'admin') ? (form.who?.value || null) : null;

  try {
    await carmApi('/carm', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        workDate: date,
        items: [
          { type: 'carm',   qty: carm },
          { type: 'arthro', qty: arthro }
        ],
        ...(createdBy ? { createdBy } : {})  // â† ê´€ë¦¬ìì¼ ë•Œë§Œ ì „ì†¡
      })
    });

    // ì €ì¥ í›„ í˜„ì¬ ì›” ë³´ë“œ ìƒˆë¡œê³ ì¹¨
    const mEl = document.getElementById('carmMonth');
    if (mEl?.value) await renderCarmBoard(mEl.value);
  } catch (ex) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + (ex?.message || ex));
  }
}, true);


</script>
 
</body>
</html>
