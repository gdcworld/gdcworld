<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Admin â€“ GDC World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- íŒŒë¹„ì½˜ (ìƒëŒ€ê²½ë¡œ) -->
  <link rel="icon" href="./favicon.png?v=3" type="image/png">

  <!-- í†¤ ìœ ì§€ -->
  <style>
    :root{ --gold:#e3c08b; --gold-2:#c4976b; --card:#3a3b41; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--gold), var(--gold-2) 60%, #8a674f);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:#fff;
    }
  </style>

  <!-- ê³µí†µ CSS -->
  <link rel="stylesheet" href="assets/common.css">


  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="assets/auth.js?v=1" defer></script>
  <script src="assets/app.js?v=1" defer></script>
</head>
<body>
  <!-- ë ˆì´ì•„ì›ƒ: ì‚¬ì´ë“œë°” + ë©”ì¸ -->
  <div class="layout">
    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <div class="brandRow">
        <img src="./gdc_logo.svg?v=1" alt="logo" style="width:28px;height:28px;">
        <div>GDC World (Admin)</div>
      </div>
      <nav class="nav">
        <!-- â–¼ ë¹„ê¸‰ì—¬ì¹˜ë£Œ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-noncovered" aria-expanded="false">
            <span class="left">ğŸ–ï¸ ë¹„ê¸‰ì—¬ì¹˜ë£Œ</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-noncovered">
            <button class="subitem" data-view="noncovered-dosu">ë„ìˆ˜ ì¹˜ë£Œ</button>
            <button class="subitem" data-view="noncovered-shock">ì¶©ê²©íŒŒ</button>
            <button class="subitem" data-view="noncovered-dosu-note">ë„ìˆ˜ì¹˜ë£Œ ìƒë‹´ì¼ì§€</button>
            <button class="subitem" data-view="noncovered-shock-note">ì¶©ê²©íŒŒ ìƒë‹´ì¼ì§€</button>
            <button class="subitem" data-view="noncovered-chart">í™˜ì ì°¨íŠ¸</button>
          </div>
        </div>

        <!-- â–¼ ì†Œëª¨í’ˆ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-consumables" aria-expanded="false">
            <span class="left">ğŸ’¼ ì†Œëª¨í’ˆ</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-consumables">
            <button class="subitem" data-view="consumables-main">ì†Œëª¨í’ˆ</button>
            <button class="subitem" data-view="consumables-stock">ì†Œëª¨í’ˆ (ì¬ê³ ê´€ë¦¬)</button>
            <button class="subitem" data-view="consumables-balance">ì†Œëª¨í’ˆ (ì”ê³ í˜„í™©)</button>
            <button class="subitem" data-view="consumables-byvendor">ì†Œëª¨í’ˆ (ê±°ë˜ì²˜ë³„)</button>
          </div>
        </div>

        <!-- â–¼ ì˜ì•½í’ˆ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-drugs" aria-expanded="false">
            <span class="left">ğŸ’Š ì˜ì•½í’ˆ</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-drugs">
            <button class="subitem" data-view="drugs-main">ì˜ì•½í’ˆ</button>
            <button class="subitem" data-view="drugs-stock">ì˜ì•½í’ˆ (ì¬ê³ ê´€ë¦¬)</button>
            <button class="subitem" data-view="drugs-balance">ì˜ì•½í’ˆ (ì”ê³ í˜„í™©)</button>
            <button class="subitem" data-view="drugs-byvendor">ì˜ì•½í’ˆ (ê±°ë˜ì²˜ë³„)</button>
          </div>
        </div>

        <!-- â–¼ ê³„ì •ê´€ë¦¬ (í•˜ìœ„ ë©”ë‰´) -->
        <div class="nav-group">
          <button class="nav-parent" data-collapse-target="#sub-accounts" aria-expanded="false">
            <span class="left">ğŸ‘¤ ê³„ì •ê´€ë¦¬</span><span class="chev">â–¾</span>
          </button>
          <div class="subnav" id="sub-accounts">
            <button class="subitem" data-view="accounts-physio">ë¬¼ë¦¬ì¹˜ë£Œì‚¬</button>
            <button class="subitem" data-view="accounts-ptadmin">PTê´€ë¦¬ì</button>
            <button class="subitem" data-view="accounts-nurse">ê°„í˜¸ì‚¬</button>
            <button class="subitem" data-view="accounts-frontdesk">ì›ë¬´</button>
            <button class="subitem" data-view="accounts-radiology">ë°©ì‚¬ì„ ì‚¬</button>
            <button class="subitem" data-view="accounts-vice">ë¶€ì›ì¥</button>
          </div>
        </div>

        <!-- ë‚˜ë¨¸ì§€ ìƒìœ„ ë©”ë‰´ (ë‹¨ì¼ ë²„íŠ¼) -->
        <button data-view="expenses"><span class="left">ğŸ“ˆ ìˆ˜ì…/ì§€ì¶œ</span>â€º</button>
        <button data-view="nhis"><span class="left">ğŸ“‹ ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©</span>â€º</button>
        <button data-view="revisit"><span class="left">ğŸ“Š ì¬ì§„ìœ¨</span>â€º</button>
        <button data-view="claims"><span class="left">ğŸ§¾ ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­</span>â€º</button>
        <button data-view="closing"><span class="left">ğŸ“ ë§ˆê°ì¼ì§€</span>â€º</button>
        <button data-view="categories"><span class="left">ğŸ—‚ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</span>â€º</button>
        <button data-view="partners"><span class="left">ğŸ¥ ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ)</span>â€º</button>
        <button data-view="carm"><span class="left">ğŸ“· C-arm</span>â€º</button>
      </nav>
    </aside>

    <!-- ë©”ì¸ -->
    <main class="main">
      <div class="headerBar">
        <h1 class="h1" id="pageTitle">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <div>
          <span id="whoami" style="opacity:.85;font-size:14px;margin-right:8px;"></span>
          <button class="btn" id="logoutBtn" type="button">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ) -->
      <section class="panel hidden" data-panel="partners" id="partnersBox">
        <h2 class="h1">ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ) ë§¤ì¶œ</h2>
        <div class="tools">
          <label>ë³‘ì› ì„ íƒ:
            <select id="hospitalSelect"></select>
          </label>
          <span id="hospitalMeta" style="opacity:.85;"></span>
          <button class="btn" id="exportCsv" type="button">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <table class="table" id="hospitalTable">
          <thead><tr><th>ì›”</th><th>ë§¤ì¶œ</th><th>ì²­êµ¬ê±´ìˆ˜</th><th>ë¹„ê³ </th></tr></thead>
          <tbody><tr><td colspan="4">ë¡œë”© ì¤‘â€¦</td></tr></tbody>
        </table>
      </section>

      <!-- ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ -->
      <section class="panel hidden" data-panel="categories" id="categoriesBox">
        <h2 class="h1">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2>
        <div class="tools" style="gap:8px; flex-wrap:wrap;">
          <label>ë©”ë‰´ ì„ íƒ:
            <select id="categoryModuleSelect">
              <option value="noncovered">ë¹„ê¸‰ì—¬ì¹˜ë£Œ</option>
              <option value="consumables">ì†Œëª¨í’ˆ</option>
              <option value="drugs">ì˜ì•½í’ˆ</option>
              <option value="income">ìˆ˜ì…/ì§€ì¶œ</option>
              <option value="nhis">ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©</option>
              <option value="revisit">ì¬ì§„ìœ¨</option>
              <option value="claims">ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­</option>
              <option value="closing">ë§ˆê°ì¼ì§€</option>
              <option value="accounts">ê³„ì •ê´€ë¦¬</option>
              <option value="partners">ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ)</option>
            </select>
          </label>

          <input id="catNameInput" type="text" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì…ë ¥"
                 style="padding:8px 10px;border-radius:8px;border:1px solid #444;background:#202227;color:#fff;min-width:220px;">
          <button class="btn" id="addCatBtn"    type="button">ì¶”ê°€</button>
          <button class="btn" id="renameCatBtn" type="button">ì´ë¦„ ë³€ê²½</button>
          <button class="btn" id="deleteCatBtn" type="button">ì‚­ì œ</button>

          <button class="btn" id="exportCatBtn" type="button">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          <label class="btn" style="cursor:pointer;">
            ê°€ì ¸ì˜¤ê¸°(JSON)
            <input id="importCatInput" type="file" accept="application/json" style="display:none;">
          </label>
        </div>

        <table class="table" id="categoryTable">
          <thead><tr><th style="width:56px;">#</th><th>ì¹´í…Œê³ ë¦¬ëª…</th></tr></thead>
          <tbody><tr><td colspan="2">ë¡œë”© ì¤‘â€¦</td></tr></tbody>
        </table>

        <p class="muted" style="margin-top:8px;">
          ì €ì¥: ë¸Œë¼ìš°ì € ë¡œì»¬ìŠ¤í† ë¦¬ì§€. ì´ˆê¸°ê°’ì€ <code>assets/data/categories.json</code>ì—ì„œ 1íšŒ ë¡œë“œë©ë‹ˆë‹¤.
        </p>
      </section>

      <!-- â–¼ ë¹„ê¸‰ì—¬ì¹˜ë£Œ í•˜ìœ„ íŒ¨ë„ -->
<section class="panel hidden" data-panel="noncovered-dosu">
  <header class="panel-head" style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
  <!-- ì™¼ìª½: í•„í„°/ë²„íŠ¼ -->
  <div class="tools" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <select id="dosuDoctor" class="select" style="min-width:110px;">
      <option value="">ì¹˜ë£Œì‚¬ ì „ì²´</option>
    </select>
<!-- âœ… ë„ìˆ˜ ì¹˜ë£Œ ì •ë³´ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="dosuModal" class="gdc-modal hidden" aria-hidden="true">
  <div class="gdc-modal__backdrop" data-close="1"></div>
  <div class="gdc-modal__panel" role="dialog" aria-modal="true" aria-labelledby="dosuModalTitle">
    <header class="gdc-modal__header">
      <h3 id="dosuModalTitle">ë„ìˆ˜ ì¹˜ë£Œ ì •ë³´ ì¶”ê°€</h3>
      <button class="gdc-modal__close" type="button" data-close="1">Ã—</button>
    </header>

    <form id="dosuForm" class="gdc-form">
      <div class="gdc-grid">
        <label class="gdc-field">
          <span class="gdc-label">ì‘ì„±ì¼</span>
          <input name="writtenAt" type="date" />
        </label>

        <label class="gdc-field">
          <span class="gdc-label">ë³‘ì›</span>
          <input name="hospital" type="text" value="êµ¬ë¡œë””ì§€í„¸ì •í˜•ì™¸ê³¼" placeholder="ë³‘ì›ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </label>

        <label class="gdc-field">
          <span class="gdc-label">ë¬¼ë¦¬ì¹˜ë£Œì‚¬</span>
          <select name="physioId" id="dosuPhysioSelect">
            <option value="">ì¹˜ë£Œì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
          </select>
        </label>

        <label class="gdc-field">
          <span class="gdc-label">í™˜ì</span>
          <input name="patient" type="text" placeholder="í™˜ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
        </label>

        <label class="gdc-field">
          <span class="gdc-label">ì§„ë£Œì‹¤</span>
          <select name="room">
            <option value="">ì§„ë£Œì‹¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option>ë„ìˆ˜ì‹¤ A</option>
            <option>ë„ìˆ˜ì‹¤ B</option>
            <option>ë„ìˆ˜ì‹¤ C</option>
          </select>
        </label>

        <label class="gdc-field">
          <span class="gdc-label">ì¸ì„¼í‹°ë¸Œ</span>
          <select name="incentive">
            <option value="">ì¸ì„¼í‹°ë¸Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="10">10%</option>
            <option value="15">15%</option>
            <option value="25">25%</option>
          </select>
        </label>

        <fieldset class="gdc-field">
          <legend class="gdc-label">ë°©ë¬¸ íƒ€ì…</legend>
          <div class="gdc-chipset">
            <label><input type="radio" name="visitType" value="new" /> ì‹ í™˜</label>
            <label><input type="radio" name="visitType" value="revisit" /> ì¬ì§„</label>
            <label><input type="radio" name="visitType" value="other" /> ê¸°íƒ€ì—¬ë¶€</label>
          </div>
        </fieldset>

        <label class="gdc-field">
          <span class="gdc-label">ê¸ˆì•¡</span>
          <select name="amount">
            <option value="">ê¸ˆì•¡ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="30000">30,000</option>
            <option value="50000">50,000</option>
            <option value="70000">70,000</option>
            <option value="100000">100,000</option>
          </select>
        </label>

        <fieldset class="gdc-field">
          <legend class="gdc-label">ì¹˜ë£Œ íƒ€ì…</legend>
          <div class="gdc-chipset">
            <label><input type="checkbox" name="treat_only" value="dosu" /> ë„ìˆ˜ì¹˜ë£Œë§Œ</label>
            <label><input type="checkbox" name="treat_inj"  value="inj"  /> +ì£¼ì‚¬ì¹˜ë£Œ</label>
            <label><input type="checkbox" name="treat_eswt" value="eswt" /> +ì¶©ê²©íŒŒì¹˜ë£Œ</label>
          </div>
        </fieldset>

        <fieldset class="gdc-field">
          <legend class="gdc-label">ì˜ˆì•½ ì—¬ë¶€</legend>
          <div class="gdc-chipset">
            <label><input type="radio" name="reservation" value="reserved" /> ì˜ˆì•½</label>
            <label><input type="radio" name="reservation" value="not_reserved" /> ë¯¸ì˜ˆì•½</label>
            <label><input type="radio" name="reservation" value="none" /> ì²´í¬ì•ˆí•¨</label>
          </div>
        </fieldset>
      </div>

      <footer class="gdc-modal__footer">
        <button type="button" class="btn ghost" data-close="1">ë‹«ê¸°</button>
        <button type="submit" class="btn">ì €ì¥</button>
      </footer>
    </form>
  </div>
</div>

 
    <input id="dosuRangeStart" type="date">
    <span style="opacity:.7;">~</span>
    <input id="dosuRangeEnd" type="date">
    <button id="dosuSearch" class="btn">ê²€ìƒ‰</button>
    <button id="dosuAdd" class="btn">ë„ìˆ˜ ì¹˜ë£Œ ì •ë³´ ì¶”ê°€</button>
  </div>

  <!-- ì˜¤ë¥¸ìª½: ì•¡ì…˜ -->
  <div style="display:flex;gap:8px;align-items:center;margin-left:auto;flex-wrap:wrap;">
    <button id="dosuReload" class="btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="dosuExport" class="btn">ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
    <button id="dosuPrint"  class="btn ghost">ì¸ì‡„</button>
  </div>
</header>

<!-- ì¤‘ì•™ íƒ€ì´í‹€ + ê¸°ê°„ -->
<div style="display:flex;align-items:flex-start;gap:16px;position:relative;margin-bottom:14px;">
  <div style="flex:1;text-align:center;">
    <h2 class="h1" style="margin:8px 0 6px;">êµ¬ë¡œë””ì§€í„¸ì •í˜•ì™¸ê³¼ ë„ìˆ˜ ì¹˜ë£Œ í˜„í™©</h2>
    <div style="opacity:.85;">
      <span id="dosuPeriodText">YYYY-MM-DD ~ YYYY-MM-DD</span>
    </div>
  </div>

  <!-- ìš°ì¸¡ ìš”ì•½ í…Œì´ë¸” -->
  <div class="panel card" style="min-width:520px;max-width:560px;margin-right:4px;">
    <div class="table-wrap">
      <table class="table compact" style="font-size:13px;">
        <thead>
          <tr>
            <th style="width:38%"></th>
            <th style="width:15%">ì‹ í™˜</th>
            <th style="width:15%">ì¬ì§„</th>
            <th style="width:15%">í•©ê³„</th>
            <th style="width:17%">ì¬ì§„ìœ¨</th>
            <th style="width:20%">ìˆ˜ìµ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ê¸°ê°„ ë‚´</td>
            <td id="dsumCurNew">0ëª…</td>
            <td id="dsumCurRe">0ëª…</td>
            <td id="dsumCurTotal">0ëª…</td>
            <td id="dsumCurRate">0%</td>
            <td id="dsumCurRevenue">0ì›</td>
          </tr>
          <tr>
            <td>í•œë‹¬ì „ ê¸°ê°„ ë‚´</td>
            <td id="dsumPrevNew">0ëª…</td>
            <td id="dsumPrevRe">0ëª…</td>
            <td id="dsumPrevTotal">0ëª…</td>
            <td id="dsumPrevRate">0%</td>
            <td id="dsumPrevRevenue">0ì›</td>
          </tr>
          <tr>
            <td>ì „ì›” ì´ í˜„í™©</td>
            <td id="dsumPrevMonthNew">0ëª…</td>
            <td id="dsumPrevMonthRe">0ëª…</td>
            <td id="dsumPrevMonthTotal">0ëª…</td>
            <td id="dsumPrevMonthRate">0%</td>
            <td id="dsumPrevMonthRevenue">0ì›</td>
          </tr>
          <tr>
            <td>í•œë‹¬ì „ ê¸°ê°„ë‚´ ëŒ€ë¹„</td>
            <td id="dsumDeltaNew">0ëª…</td>
            <td id="dsumDeltaRe">0ëª…</td>
            <td id="dsumDeltaTotal">0ëª…</td>
            <td id="dsumDeltaRate">0%</td>
            <td id="dsumDeltaRevenue">0ì›</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


  <!-- KPI -->
  <div class="kpi-wrap" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:16px;">
    <div class="panel card"><div class="kpi-name">ê¸°ê°„ ë‚´</div><div id="dosuKpiCur" class="kpi-val">0ëª…</div></div>
    <div class="panel card"><div class="kpi-name">ì „ì›” ë™ì¼ê¸°ê°„</div><div id="dosuKpiPrev" class="kpi-val">0ëª…</div></div>
    <div class="panel card"><div class="kpi-name">ì¬ì§„ìœ¨</div><div id="dosuKpiRevisit" class="kpi-val">0%</div></div>
    <div class="panel card"><div class="kpi-name">ìˆ˜ìµ(ì›)</div><div id="dosuKpiRevenue" class="kpi-val">0</div></div>
  </div>

  <!-- ì¹˜ë£Œì‚¬ë³„ ë§¤ì¶œ -->
  <div class="panel card">
    <div class="card-head"><strong>ì¹˜ë£Œì‚¬ë³„ ë§¤ì¶œ</strong></div>
    <div class="table-wrap">
      <table class="table" id="dosuByTherapist">
        <thead>
          <tr><th>ì¹˜ë£Œì‚¬</th><th>ë‚´ì›ìˆ˜</th><th>ì‹ í™˜</th><th>ì¬ì§„</th><th>ì¬ì§„ìœ¨</th><th>ìˆ˜ìµ(ì›)</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><th>í•©ê³„</th><th id="dosuSumVisit">0</th><th id="dosuSumNew">0</th><th id="dosuSumRe">0</th>
              <th id="dosuSumRate">0%</th><th id="dosuSumRevenue">0</th></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- 2ì—´: ì‹ í™˜ ë¶„ë°° / ì´ ì¬ì§„ -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
    <div class="panel card">
      <div class="card-head"><strong>ì‹ í™˜ ë¶„ë°° í˜„í™©</strong></div>
      <div class="table-wrap">
        <table class="table" id="dosuNewDist">
          <thead><tr><th>ì¹˜ë£Œì‚¬</th><th>10ë§Œ</th><th>15ë§Œ</th><th>25ë§Œ</th><th>í•©ê³„</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel card">
      <div class="card-head"><strong>ì´ ì¬ì§„ í˜„í™©</strong></div>
      <div class="table-wrap">
        <table class="table" id="dosuRevisit">
          <thead><tr><th>ì¹˜ë£Œì‚¬</th><th>10ë§Œ</th><th>15ë§Œ</th><th>25ë§Œ</th><th>í•©ê³„</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ê¸°ê°„ë³„ í˜„í™© -->
  <div class="panel card" style="margin-top:12px;">
    <div class="card-head"><strong>ê¸°ê°„ë³„ í˜„í™©</strong></div>
    <div class="table-wrap">
      <table class="table" id="dosuDaily">
        <thead>
          <tr><th>ì¼ì</th><th>ë‚´ì›ìˆ˜</th><th>ì‹ í™˜</th><th>ì¬ì§„</th><th>ì¬ì§„ìœ¨</th><th>ìˆ˜ìµ(ì›)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

      <section class="panel hidden" data-panel="noncovered-shock"><h2 class="h1">ì¶©ê²©íŒŒ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="noncovered-dosu-note"><h2 class="h1">ë„ìˆ˜ì¹˜ë£Œ ìƒë‹´ì¼ì§€</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="noncovered-shock-note"><h2 class="h1">ì¶©ê²©íŒŒ ìƒë‹´ì¼ì§€</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="noncovered-chart"><h2 class="h1">í™˜ì ì°¨íŠ¸</h2>ì¤€ë¹„ ì¤‘</section>

      <!-- â–¼ ì†Œëª¨í’ˆ í•˜ìœ„ íŒ¨ë„ -->
      <section class="panel hidden" data-panel="consumables-main"><h2 class="h1">ì†Œëª¨í’ˆ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="consumables-stock"><h2 class="h1">ì†Œëª¨í’ˆ (ì¬ê³ ê´€ë¦¬)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="consumables-balance"><h2 class="h1">ì†Œëª¨í’ˆ (ì”ê³ í˜„í™©)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="consumables-byvendor"><h2 class="h1">ì†Œëª¨í’ˆ (ê±°ë˜ì²˜ë³„)</h2>ì¤€ë¹„ ì¤‘</section>

      <!-- â–¼ ì˜ì•½í’ˆ í•˜ìœ„ íŒ¨ë„ -->
      <section class="panel hidden" data-panel="drugs-main"><h2 class="h1">ì˜ì•½í’ˆ</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="drugs-stock"><h2 class="h1">ì˜ì•½í’ˆ (ì¬ê³ ê´€ë¦¬)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="drugs-balance"><h2 class="h1">ì˜ì•½í’ˆ (ì”ê³ í˜„í™©)</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="drugs-byvendor"><h2 class="h1">ì˜ì•½í’ˆ (ê±°ë˜ì²˜ë³„)</h2>ì¤€ë¹„ ì¤‘</section>

      <!-- â–¼ ê³„ì •ê´€ë¦¬ í•˜ìœ„ íŒ¨ë„ (account-module) -->
      <section class="panel hidden" data-panel="accounts-physio">
        <h2 class="h1">ë¬¼ë¦¬ì¹˜ë£Œì‚¬</h2>
        <div class="account-module" data-role="physio"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-ptadmin">
        <h2 class="h1">PTê´€ë¦¬ì</h2>
        <div class="account-module" data-role="ptadmin"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-nurse">
        <h2 class="h1">ê°„í˜¸ì‚¬</h2>
        <div class="account-module" data-role="nurse"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-frontdesk">
        <h2 class="h1">ì›ë¬´</h2>
        <div class="account-module" data-role="frontdesk"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-radiology">
        <h2 class="h1">ë°©ì‚¬ì„ ì‚¬</h2>
        <div class="account-module" data-role="radiology"></div>
      </section>

      <section class="panel hidden" data-panel="accounts-vice">
        <h2 class="h1">ë¶€ì›ì¥</h2>
        <div class="account-module" data-role="vice"></div>
      </section>

   <!-- C-arm ì›”ê°„ ëŒ€ì‹œë³´ë“œ -->
<section class="panel hidden" data-panel="carm">
  <h2 class="h1">C-arm ì›”ê°„ ëŒ€ì‹œë³´ë“œ</h2>

  <div class="tools" style="display:flex; gap:8px; margin-bottom:12px; align-items:center; flex-wrap:wrap;">
    <input id="carmMonth" type="month"
      style="padding:8px 10px;border-radius:8px;border:1px solid #444;background:#202227;color:#fff;">
    <button class="btn" id="carmMonthPrev" type="button">ì´ì „</button>
    <button class="btn" id="carmMonthNext" type="button">ë‹¤ìŒ</button>
    <button class="btn" id="carmMonthLoad" type="button">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <!-- ë‹¬ë ¥í˜• 7ì—´ ë³´ë“œ -->
  <div id="carmBoard"
   style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px;">
     <!-- JSì—ì„œ ì¼ì ì¹´ë“œ ìƒì„± -->
  </div>
</section>


      <!-- ê¸°ì¡´ ë‹¨ì¼ íŒ¨ë„ -->
      <section data-panel="expenses" class="panel hidden">
  <h2 class="h1" style="margin-bottom:8px;">ì§€ì¶œ(ë³‘ì›ì¹´ë“œ) ì›”ê°„ ëŒ€ì‹œë³´ë“œ</h2>

  <!-- ì»¨íŠ¸ë¡¤ -->
  <div class="tools" style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
    <input id="expMonth" type="month"
           style="padding:10px; border-radius:10px; border:1px solid #444;
                  background:#1f2025; color:#fff;">
    <button class="btn" id="expPrev">ì´ì „</button>
    <button class="btn" id="expNext">ë‹¤ìŒ</button>
    <button class="btn" id="expReload">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn" id="expExport" type="button">ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
    <div style="margin-left:auto; font-weight:800;">
      ì›” í•©ê³„: <span id="expTotal">0</span>ì›
    </div>
  </div>

  <!-- ì…ë ¥ í¼ -->
  <form id="expForm" class="panel" onsubmit="return false"
      style="display:grid; grid-template-columns: 140px 1fr 1fr 2fr auto;
             gap:8px; align-items:center;">
    <input name="payDate" type="date" required
           style="padding:10px; border-radius:10px; border:1px solid #444;
                  background:#1f2025; color:#fff;">
    <input name="amount" type="number" min="1" step="1" placeholder="ê¸ˆì•¡(ì›)" required
           style="padding:10px; border-radius:10px; border:1px solid #444;
                  background:#1f2025; color:#fff;">
    <input name="merchant" type="text" placeholder="ìƒí˜¸ëª…" required
           style="padding:10px; border-radius:10px; border:1px solid #444;
                  background:#1f2025; color:#fff;">
    <input name="purpose" type="text" placeholder="ìš©ë„" required
           style="padding:10px; border-radius:10px; border:1px solid #444;
                  background:#1f2025; color:#fff;">
    <button class="btn" type="submit">ì¶”ê°€</button>
    <input type="hidden" name="method" value="hospital_card">
  </form>

  <!-- ëª©ë¡ -->
  <div class="panel" style="padding:0;">
    <table class="table" id="expTable">
      <thead>
        <tr>
          <th style="width:120px;">ë‚ ì§œ</th>
          <th style="width:120px; text-align:right;">ê¸ˆì•¡(ì›)</th>
          <th>ìƒí˜¸ëª…</th>
          <th>ìš©ë„</th>
          <th style="width:110px;">ì‘ì—…</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

      <section class="panel hidden" data-panel="nhis"><h2 class="h1">ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="revisit"><h2 class="h1">ì¬ì§„ìœ¨</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="claims"><h2 class="h1">ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­</h2>ì¤€ë¹„ ì¤‘</section>
      <section class="panel hidden" data-panel="closing"><h2 class="h1">ë§ˆê°ì¼ì§€</h2>ì¤€ë¹„ ì¤‘</section>
    </main>
  </div>

  <!-- ì¸ì¦/ë¡œê·¸ì•„ì›ƒ/ë„¤ë¹„ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
document.addEventListener('DOMContentLoaded', function(){
  if (!window.Auth) { alert('auth.js ë¡œë“œ ì‹¤íŒ¨'); return; }
  Auth.requireRole();

  // ë¹„ê´€ë¦¬ì í—¤ë” ìˆ¨ê¹€
  const role = ((window.Auth && Auth.currentRole && Auth.currentRole()) || 'member').toLowerCase();
  if (role !== 'admin') document.getElementById('pageTitle')?.classList.add('hidden');

  const emailEl = document.getElementById('whoami');
  if (emailEl) emailEl.textContent = Auth.currentUserEmail() || '';
  document.getElementById('logoutBtn')?.addEventListener('click', ()=>{ Auth.logout(); location.replace('index.html'); });

  // â”€ ì—­í•  ì ‘ê·¼í‘œ â”€
  const VIEW_ACCESS = {
    admin:'ALL',
    frontdesk:['expenses','closing'],
    nurse:['consumables-*','drugs-*'],
    physio:['noncovered-*'],
    ptadmin:[], radiology:['carm'], vice:[], staff:[], member:[]
  };

  function matchesAny(id, patterns){
    return patterns.some(p=>{
      if (p === '*') return true;
      if (p.endsWith('*')) return id.startsWith(p.slice(0,-1));
      return p === id;
    });
  }

  // â–¼ allow/allowAllì„ ì´ í•¨ìˆ˜ "ì•ˆì—ì„œ"ë§Œ ì‚¬ìš©
  function applyRoleVisibility(roleStr){
    const allow = (roleStr in VIEW_ACCESS) ? VIEW_ACCESS[roleStr] : [];
    const allowAll = allow === 'ALL';

    // ë²„íŠ¼ í† ê¸€
    document.querySelectorAll('.nav [data-view]').forEach(btn=>{
      const v = btn.dataset.view;
      const ok = allowAll || matchesAny(v, allow);
      btn.classList.toggle('hidden', !ok);
    });

    // íŒ¨ë„ í† ê¸€
    document.querySelectorAll('[data-panel]').forEach(p=>{
      const id = p.dataset.panel;
      const ok = allowAll || matchesAny(id, allow);
      p.classList.toggle('hidden', !ok);
    });
     
  if (roleStr !== 'admin') {
    document.querySelector('[data-view="partners"]')?.classList.add('hidden');
    document.querySelector('[data-panel="partners"]')?.classList.add('hidden');
  }

    // ë¹„ì–´ìˆëŠ” ê·¸ë£¹ ê°ì¶”ê¸°
    document.querySelectorAll('.nav-group').forEach(grp=>{
      const subs = grp.querySelectorAll('.subitem[data-view]');
      if (subs.length){
        const anyVisible = Array.from(subs).some(s=>!s.classList.contains('hidden'));
        grp.classList.toggle('hidden', !anyVisible);
      }
    });

    // ì²« í—ˆìš© ë©”ë‰´ë¡œ ì§„ì…(ìˆì„ ë•Œë§Œ)
    const prefer    = document.querySelector('.nav [data-view="carm"]:not(.hidden)');
    const firstBtn  = prefer || document.querySelector('.nav [data-view]:not(.hidden)');
     const firstView = firstBtn ? firstBtn.dataset.view : null;
    if (firstView && typeof showPanel === 'function') showPanel(firstView);
    else document.querySelectorAll('[data-panel]').forEach(p => p.classList.add('hidden'));
  }

  // ì‚¬ì´ë“œë°” í† ê¸€/í´ë¦­
  document.querySelectorAll('.nav-parent').forEach(parent=>{
    const targetSel = parent.getAttribute('data-collapse-target');
    const box = targetSel ? document.querySelector(targetSel) : null;
    parent.addEventListener('click', ()=>{
      const open = parent.getAttribute('aria-expanded') === 'true';
      parent.setAttribute('aria-expanded', String(!open));
      if (box) box.classList.toggle('open', !open);
    });
  });
  document.querySelectorAll('.nav [data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=> showPanel(btn.dataset.view));
  });

  // íŒ¨ë„ ì „í™˜
  const titleMap = {
    'noncovered-dosu':'ë„ìˆ˜ ì¹˜ë£Œ', 'noncovered-shock':'ì¶©ê²©íŒŒ',
    'noncovered-dosu-note':'ë„ìˆ˜ì¹˜ë£Œ ìƒë‹´ì¼ì§€', 'noncovered-shock-note':'ì¶©ê²©íŒŒ ìƒë‹´ì¼ì§€',
    'noncovered-chart':'í™˜ì ì°¨íŠ¸',
    'consumables-main':'ì†Œëª¨í’ˆ','consumables-stock':'ì†Œëª¨í’ˆ (ì¬ê³ ê´€ë¦¬)',
    'consumables-balance':'ì†Œëª¨í’ˆ (ì”ê³ í˜„í™©)','consumables-byvendor':'ì†Œëª¨í’ˆ (ê±°ë˜ì²˜ë³„)',
    'drugs-main':'ì˜ì•½í’ˆ','drugs-stock':'ì˜ì•½í’ˆ (ì¬ê³ ê´€ë¦¬)','drugs-balance':'ì˜ì•½í’ˆ (ì”ê³ í˜„í™©)','drugs-byvendor':'ì˜ì•½í’ˆ (ê±°ë˜ì²˜ë³„)',
    'accounts-physio':'ë¬¼ë¦¬ì¹˜ë£Œì‚¬','accounts-ptadmin':'PTê´€ë¦¬ì','accounts-nurse':'ê°„í˜¸ì‚¬',
    'accounts-frontdesk':'ì›ë¬´','accounts-radiology':'ë°©ì‚¬ì„ ì‚¬','accounts-vice':'ë¶€ì›ì¥',
    'partners':'ê³„ì•½ ë³‘ì›(íŒŒíŠ¸ë„ˆ)','categories':'ì¹´í…Œê³ ë¦¬ ê´€ë¦¬',
    'income':'ìˆ˜ì…/ì§€ì¶œ','nhis':'ê³µë‹¨ ìˆ˜ë ¹ í˜„í™©','revisit':'ì¬ì§„ìœ¨','claims':'ì§„ë£Œë¹„ ì²­êµ¬ ë‚´ì—­','closing':'ë§ˆê°ì¼ì§€','expenses':'ìˆ˜ì…/ì§€ì¶œ',
    'carm':'C-arm'
  };
  window.showPanel = function(id){
   const roleNow = (window.Auth?.currentRole?.() || 'member').toLowerCase();
  if (id === 'partners' && roleNow !== 'admin') {
    const prefer = document.querySelector('.nav [data-view="carm"]:not(.hidden)');
    const fb = prefer || document.querySelector('.nav [data-view]:not(.hidden)');
    if (!fb) { document.querySelectorAll('[data-panel]').forEach(p=>p.classList.add('hidden')); return; }
    id = fb.dataset.view; // radiologyë©´ C-arm, ê·¸ ì™¸ì—” ê°ì ì²« ë©”ë‰´
  }
    document.querySelectorAll('[data-panel]').forEach(p=>{
      p.classList.toggle('hidden', p.getAttribute('data-panel') !== id);
    });
    const h = document.getElementById('pageTitle');
    if (h) h.textContent = titleMap[id] || h.textContent;
    document.querySelectorAll('.subitem').forEach(b=>{
      b.classList.toggle('active', b.dataset.view === id);
    });
    if (window.__bootAccountsModules) {
      const panelEl = document.querySelector(`[data-panel="${id}"]`);
     window.__bootAccountsModules(panelEl);
    }
     if (id === 'expenses' && window.renderExpenses) window.renderExpenses();
      if (id === 'carm' && window.initCarmMonth) window.initCarmMonth();
    if (id === 'noncovered-dosu') {
      if (window.renderDosu) window.renderDosu();
      if (window.bootDosuAddUI) window.bootDosuAddUI();   // â† ì´ ì¤„ ì¶”ê°€
    }
   };

  // â˜† ë§ˆì§€ë§‰ì— í•œ ë²ˆë§Œ í˜¸ì¶œ
  applyRoleVisibility(role);
});
</script>

  <!-- ê³„ì •ê´€ë¦¬ í…Œì´ë¸” ëª¨ë“ˆ -->
  <script src="assets/accounts.js?v=3" defer></script>

  <!-- ê³„ì • ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="account-modal" class="modal hidden">
    <div class="modal-card">
      <h3 id="account-modal-title">ê³„ì • ìƒì„±</h3>
      <form id="account-form">
        <div class="grid">
          <label>ë¡œê·¸ì¸ ID
            <input name="loginId" type="text" required placeholder="physio_user1" />
          </label>
          <label>ë¹„ë°€ë²ˆí˜¸
            <div style="display:flex;align-items:center;gap:6px;">
              <input name="password" type="password" placeholder="ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸" style="flex:1;" />
              <button type="button" class="btn ghost toggle-pass" data-target="password">ë³´ê¸°</button>
            </div>
          </label>

          <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            <div style="display:flex;align-items:center;gap:6px;">
              <input name="password2" type="password" placeholder="ë‹¤ì‹œ ì…ë ¥" style="flex:1;" />
              <button type="button" class="btn ghost toggle-pass" data-target="password2">ë³´ê¸°</button>
            </div>
          </label>

          <label>ì´ë¦„
            <input name="name" type="text" required placeholder="í™ê¸¸ë™" />
          </label>
          <label>ì´ë©”ì¼
            <input name="email" type="email" placeholder="user@example.com" />
          </label>
          <label>ì „í™”ë²ˆí˜¸
            <input name="phone" type="tel" placeholder="010-1234-5678" />
          </label>
          <label>ìƒíƒœ
            <select name="status" required>
              <option value="active">í™œì„±</option>
              <option value="inactive">ë¹„í™œì„±</option>
            </select>
          </label>

          <!-- â–¼ ê¶Œí•œ(ì—­í• ) ì„ íƒ -->
          <label>ê¶Œí•œ(ì—­í• )
            <select name="role" required>
              <option value="physio">ë¬¼ë¦¬ì¹˜ë£Œì‚¬</option>
              <option value="ptadmin">PTê´€ë¦¬ì</option>
              <option value="nurse">ê°„í˜¸ì‚¬</option>
              <option value="frontdesk">ì›ë¬´</option>
              <option value="radiology">ë°©ì‚¬ì„ ì‚¬</option>
              <option value="vice">ë¶€ì›ì¥</option>
              <option value="staff">ìŠ¤íƒœí”„</option>
              <option value="member">ë©¤ë²„</option>
              <option value="admin">ê´€ë¦¬ì</option>
            </select>
          </label>
        </div>

        <!-- ì—­í• ë³„ ì¶”ê°€ í•„ë“œ ë™ì  ì£¼ì… ì˜ì—­ -->
        <div class="grid" id="extra-fields" style="margin-top:10px;"></div>

        <div class="row right">
          <button type="button" class="btn ghost" id="account-cancel">ì·¨ì†Œ</button>
          <button type="submit" class="btn primary" id="account-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ê°„ë‹¨ í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast hidden"></div>

  <style>
    .hidden{display:none}
    .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:1000}
    .modal-card{width:min(620px, 92vw); background:#2b2d33; color:#fff; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .modal-card h3{margin:0 0 12px}
    .modal-card .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .modal-card label{display:flex; flex-direction:column; gap:6px; font-size:14px}
    .modal-card input, .modal-card select{
      padding:10px 12px; border:1px solid #444; border-radius:10px; background:#1f2025; color:#fff; outline:none
    }
    .row.right{display:flex; gap:8px; justify-content:flex-end; margin-top:14px}
    .btn{padding:10px 14px; border-radius:10px; border:1px solid transparent; background:#3a3b41; color:#fff; cursor:pointer}
    .btn.primary{background:var(--gold-2)}
    .btn.ghost{background:transparent; border-color:#555}
    .toast{position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
           background:#1f2025; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #444; z-index:1100}
  </style>

  <script>
    // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".toggle-pass");
      if (!btn) return;
      let scope = btn.closest("label, .row, .field, div");
      let input = scope?.querySelector(`input[name="${btn.dataset.target || ""}"]`);
      if (!input) input = scope?.querySelector('input[type="password"], input[type="text"]');
      if (!input) return;
      input.type = (input.type === "password") ? "text" : "password";
      btn.textContent = (input.type === "password") ? "ë³´ê¸°" : "ìˆ¨ê¸°ê¸°";
    });
  </script>

<script>
/* C-arm í¼ ì•ˆì—ì„œ Enter, Ctrl+S/âŒ˜S â†’ ì €ì¥ */
window.handleCarmHotkeys = function (e) {
  const form = e.target && e.target.closest && e.target.closest('form.carm-inline');
  if (!form) return;

  // Ctrl+S / Cmd+S
  if ((e.key === 's' || e.key === 'S') && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    form.requestSubmit();
    return false;
  }

  // Enter (Shift+EnterëŠ” ì œì™¸)
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    form.requestSubmit();
    return false;
  }
};
</script>

<script>
(function(){
  // API í˜¸ì¶œ: /api ìš°ì„ , ì‹¤íŒ¨ ì‹œ /.netlify/functions í´ë°±
  window.carmApi = async function(path, opts = {}){
  const token = (window.Auth?.currentToken && Auth.currentToken()) || null;
  const defaultHeaders = {
    'Content-Type': 'application/json',
    ...(token ? { Authorization: `Bearer ${token}` } : {})
  };
  const init = {
    // ê¸°ë³¸ê°’ì€ GET, í˜¸ì¶œë¶€ì—ì„œ method ì§€ì • ê°€ëŠ¥
    method: opts.method || 'GET',
    body: opts.body,
    headers: { ...defaultHeaders, ...(opts.headers || {}) }
  };

  let r = await fetch('/api' + path, init);
  if (!r.ok) r = await fetch('/.netlify/functions/api' + path, init);

  let j = null;
  try { j = await r.json(); } catch {}
  if (!r.ok || j?.ok === false) throw new Error(j?.message || 'request_failed');
  return j;
}

  const fmtMonth = (d)=> d.toISOString().slice(0,7);
//
window.getRole  = () => ((window.Auth?.currentRole && Auth.currentRole()) || 'member').toLowerCase();
window.getEmail = () => (window.Auth?.currentUserEmail && Auth.currentUserEmail()) || '';

let __carmUsers = null;
async function loadCarmUsers(){
  if (__carmUsers) return __carmUsers;

  const token = (window.Auth?.currentToken && Auth.currentToken()) || null;
  const headers = token ? { Authorization: `Bearer ${token}` } : {};
  const r = await fetch('/api/carm/users', { headers });
  const j = await r.json().catch(()=>({}));

  const admins = (j.admins || []).map(u => ({ id:u.id, name:u.name || 'ê´€ë¦¬ì' }));
  const radios = (j.radiology || []).map(u => ({ id:u.id, name:u.name || 'ë¬´ëª…' }));
  __carmUsers = [...admins, ...radios];     // ê´€ë¦¬ì ìš°ì„ , ë‹¤ìŒ ë°©ì‚¬ì„ ì‚¬
  return __carmUsers;
}


//
function dayCard(dayLabel, items, ymd, canEdit, totalC, totalA){
  const role = (window.Auth && Auth.currentRole && Auth.currentRole()) || null;

  const adminSelectHTML = (role === 'admin' || role === 'radiology')
    ? `<select name="who" class="rad-select"
       style="height:36px;padding:6px 10px;border-radius:8px;border:1px solid #444;
              background:#1f2025;color:#fff; width:auto; max-width:140px; flex:0 0 auto; white-space:nowrap;"></select>`
  : '';

  return `
    <div class="panel" style="padding:10px;">
      <div style="display:inline-block;white-space:nowrap;background:var(--gold);color:#111;
                  font-weight:700;font-size:13px;padding:4px 10px;border-radius:6px;margin-bottom:6px;">
        ${dayLabel}
      </div>

      ${canEdit ? `
      <form class="carm-inline" data-date="${ymd}" onkeydown="return handleCarmHotkeys(event)"
       style="margin-top:6px; display:grid; gap:8px;">
        <div style="display:flex; align-items:center; gap:6px; flex-wrap:nowrap;">
          ${adminSelectHTML}
          <input name="carm"   type="number" min="0" placeholder="C-arm"
                 style="height:36px;width:60px;text-align:center;
                        padding:6px 10px;border-radius:8px;border:1px solid #444;
                        background:#1f2025;color:#fff;">
          <input name="arthro" type="number" min="0" placeholder="ê´€ì ˆê²½"
                 style="height:36px;width:60px;text-align:center;
                        padding:6px 10px;border-radius:8px;border:1px solid #444;
                        background:#1f2025;color:#fff;">
        </div>

        <div style="display:flex; align-items:center; gap:8px;">
          <div style="font-weight:800;">total ${totalC}/${totalA}</div>
          <button class="btn" type="submit" style="height:36px; padding:6px 14px;">ì €ì¥</button>
           <!-- ìˆ˜ì • = ì´ˆê¸°í™”(ë®ì–´ì“°ê¸°) -->
  <button class="btn" type="submit" data-mode="set"
          style="height:36px; padding:6px 14px;">ìˆ˜ì •</button>
</div>
      </form>
      ` : ``}
    </div>
  `;
}

 window.renderCarmBoard = async function(monthStr){
  const grid = document.getElementById('carmBoard');
  if (!grid) return;
  grid.innerHTML = `<div class="panel" style="grid-column:1/-1;padding:12px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

  // ì•ˆì „í•˜ê²Œ í˜¸ì¶œ (ê¶Œí•œ ì—ëŸ¬ ë“± í‘œì‹œ)
  let j;
  try {
   j = await carmApi(`/carm/summary?month=${encodeURIComponent(monthStr)}&_=${Date.now()}`);
  } catch (e) {
    grid.innerHTML = `<div class="panel" style="grid-column:1/-1;padding:12px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e?.message || e}</div>`;
    return;
  }

  const users = j.users || [];
  const rows  = j.rows  || [];

  const role = getRole();
const canEdit = ['admin', 'radiology'].includes(role);

  const daysHTML = rows.map(row=>{
  const items = users.map(u => ({
    name: u,
    carm: Number(row[`${u}__carm`]|| 0),
    arthro: Number(row[`${u}__arthro`]|| 0),
  }));

  const mm  = Number(monthStr.slice(5,7));
  const dd  = String(row.day).padStart(2,'0');
  const ymd = `${monthStr}-${dd}`;
  const dayLabel = `${mm}ì›” ${row.day}ì¼`;

  // ë‚ ì§œë³„ total (ì—†ìœ¼ë©´ 0/0)
  const sum = (j.daysSum && j.daysSum[row.day]) || { carm:0, arthro:0 };

  return dayCard(dayLabel, items, ymd, canEdit, sum.carm, sum.arthro);
}).join('');

const totals = j.totals || {}; // { ì‚¬ìš©ìì´ë¦„: {carm, arthro} }
const monthTotalHTML = `
  <div class="panel" style="padding:10px;">
    <div style="display:inline-block;white-space:nowrap;background:var(--gold);color:#111;
                font-weight:800;font-size:13px;padding:4px 10px;border-radius:6px;margin-bottom:6px;">
      ì›” í•©ê³„
    </div>
    <div style="display:flex; flex-direction:column; gap:6px; min-width:180px;">
      ${
        users.map(u=>{
          const t = totals[u] || {carm:0, arthro:0};
          return `
            <div style="display:flex; justify-content:space-between; gap:12px;
                        background:#1f2025; border:1px solid #444; border-radius:10px; padding:8px 10px;">
              <div style="font-weight:700; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${u}</div>
              <div style="font-weight:800;">${t.carm}/${t.arthro}</div>
            </div>
          `;
        }).join('')
      }
    </div>
  </div>
`;

 const roleNow = getRole();
grid.innerHTML = daysHTML + monthTotalHTML;

try {
  const r = await fetch('/api/carm/users', {
    headers: {
      'Content-Type': 'application/json',
      ...(window.Auth?.currentToken?.() ? { Authorization: `Bearer ${Auth.currentToken()}` } : {})
    }
  });
  const j = await r.json();
  const admins = (j.admins || []).map(x => ({ id: x.id, name: x.name || 'ê´€ë¦¬ì' }));
  const radios  = (j.radiology || []).map(x => ({ id: x.id, name: x.name || 'ë¬´ëª…' }));

  const optsHTML = [...admins, ...radios]
    .map(u => `<option value="${u.id}">${u.name}</option>`)
    .join('');

  document.querySelectorAll('.rad-select').forEach(sel => {
    sel.innerHTML = optsHTML;
  });
} catch (e) {
  console.warn('carm/users load failed:', e);
}
}

  function initCarmMonth(){
  const panel = document.querySelector('[data-panel="carm"]');
  if (panel?.dataset.inited === '1') return;   // â† ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ì¬ì‹¤í–‰ X
  if (panel) panel.dataset.inited = '1';

  const mEl = document.getElementById('carmMonth');
  if (!mEl) return;
  if (!mEl.value) mEl.value = fmtMonth(new Date());

  const load = () => {
    const v = mEl.value;
    if (v) renderCarmBoard(v).catch(e => alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message));
  };

    document.getElementById('carmMonthLoad')?.addEventListener('click', load);
    document.getElementById('carmMonthPrev')?.addEventListener('click', ()=>{
      const d = new Date((mEl.value || fmtMonth(new Date())) + '-01');
      d.setMonth(d.getMonth() - 1);
      mEl.value = fmtMonth(d);
      load();
    });
    document.getElementById('carmMonthNext')?.addEventListener('click', ()=>{
      const d = new Date((mEl.value || fmtMonth(new Date())) + '-01');
      d.setMonth(d.getMonth() + 1);
      mEl.value = fmtMonth(d);
      load();
    });

    // ì²« ë¡œë“œ
    load();
  }
window.initCarmMonth = initCarmMonth;
  // C-arm íƒ­ ì§„ì… ì‹œì—ë§Œ ë¶€íŒ…
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.nav [data-view="carm"]');
    if (btn) initCarmMonth();
  });

  // ë§Œì•½ í˜„ì¬ íƒ­ì´ ì´ë¯¸ C-armì´ë¼ë©´ ì¦‰ì‹œ ë¶€íŒ…
  const carmPanel = document.querySelector('[data-panel="carm"]');
  if (carmPanel && !carmPanel.classList.contains('hidden')) {
    initCarmMonth();
  }
})();

document.addEventListener('submit', async (e)=>{
  const form = e.target.closest('.carm-inline');
  if (!form) return;
  e.preventDefault();

  const date   = form.dataset.date;
  const carm   = Math.max(0, parseInt(form.carm?.value   || '0', 10));
  const arthro = Math.max(0, parseInt(form.arthro?.value || '0', 10));
  const createdBy = (getRole() === 'admin') ? (form.who?.value || null) : null;

  // í´ë¦­í•œ ë²„íŠ¼ì´ ê°€ì§„ data-mode ì‚¬ìš©: ê¸°ë³¸ê°’ì€ 'add'
  const mode = (e.submitter && e.submitter.dataset && e.submitter.dataset.mode) || 'add';

  try {
    await carmApi('/carm', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        workDate: date,
        items: [
          { type: 'carm',   qty: carm },
          { type: 'arthro', qty: arthro }
        ],
        mode,                                // â† í•µì‹¬!
        ...(createdBy ? { createdBy } : {})
      })
    });

    const mEl = document.getElementById('carmMonth');
    if (mEl?.value) {
      await renderCarmBoard(mEl.value);
    }
  } catch (ex) {
    alert((mode === 'set' ? 'ìˆ˜ì • ì‹¤íŒ¨: ' : 'ì €ì¥ ì‹¤íŒ¨: ') + (ex?.message || ex));
  }
}, true);
</script>
 
</body>
</html>
