<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GDC World — 로그인</title>

  <!-- favicon -->
  <link rel="icon" type="image/png" href="favicon.png?v=3" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <!-- fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --gold:#e3c08b; --gold-2:#c4976b; --card:#3a3b41; }
    body{
      margin:0; font-family:Inter,'Noto Sans KR',sans-serif; color:#fff;
      height:100vh; display:grid; place-items:center; position:relative;
      background:linear-gradient(180deg, var(--gold), var(--gold-2));
      padding:24px;
    }
    body::after{content:""; position:fixed; inset:0; pointer-events:none;
      box-shadow: inset 0 0 180px 60px rgba(0,0,0,.3);
    }
    .login-container{
      background: var(--card);
      padding:40px 34px 44px;
      border-radius:20px;
      width:100%; max-width:420px; text-align:center;
      box-shadow: 0 22px 70px rgba(0,0,0,.5);
      border:1px solid rgba(255,255,255,.08);
    }
    .logo{ display:inline-block; margin-bottom:10px; }
    .logo img{ width:120px; height:auto; display:block; border-radius:8px; filter:drop-shadow(0 2px 4px rgba(0,0,0,.35)); background:transparent; }
    h2{ margin:6px 0 22px; font-weight:700; font-size:20px; color:var(--gold); letter-spacing:.2px; }
    .field{ text-align:left; }
    input{
      width:100%; padding:14px 16px; margin-top:10px; margin-bottom:16px;
      border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#343a46; color:#fff; font-size:15px; outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input::placeholder{ color:rgba(255,255,255,.55); }
    input:focus{ border-color:var(--gold); box-shadow:0 0 0 4px rgba(227,192,139,.2); }
    .login-button{
      padding:10px 26px; border:0; border-radius:14px;
      background:linear-gradient(90deg, var(--gold), var(--gold-2));
      color:#0f1318; font-weight:800; cursor:pointer; display:block; margin:4px auto 0;
      box-shadow:0 12px 28px rgba(227,192,139,.35);
    }
    .login-button:hover{ transform: translateY(-1px); box-shadow:0 10px 18px rgba(227,192,139,.4); }
    .login-button:active{ transform: translateY(0); box-shadow:0 4px 10px rgba(227,192,139,.3); }
    .form-wrap{ max-width:320px; margin:0 auto; }
    .error{ margin-top:12px; color:#ffb6b6; font-size:13px; min-height:1.2em; text-align:center }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo">
      <img id="brandLogo" src="./gdc_logo.png?v=1" alt="GDC World Logo" width="120" decoding="async" loading="eager" />
    </div>
    <h2>GDC World</h2>

    <form id="loginForm" autocomplete="on">
      <div class="form-wrap">
        <div class="field">
          <input id="email" name="email" type="email" placeholder="ID (이메일)" autocomplete="username" required />
        </div>
        <div class="field">
          <input id="password" name="password" type="password" placeholder="Password" autocomplete="current-password" required />
        </div>
        <button id="loginBtn" type="submit" class="login-button">Login</button>
        <div id="err" class="error"></div>
      </div>
    </form>
  </div>

  <!-- 로고 폴백 템플릿 -->
  <template id="inlineLogo">
    <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 200 200" aria-label="GDC World Logo">
      <rect x="0" y="0" width="100" height="100" fill="#C9A062" rx="20" ry="20"/>
      <path d="M25 25 H75 V75" stroke="white" stroke-width="15" fill="none" />
      <rect x="100" y="0" width="100" height="100" fill="#2C3038" rx="20" ry="20"/>
      <circle cx="150" cy="30" r="8" fill="white" />
      <circle cx="150" cy="55" r="8" fill="white" />
      <circle cx="150" cy="80" r="8" fill="white" />
      <rect x="0" y="100" width="100" height="100" fill="#2C3038" rx="20" ry="20"/>
      <path d="M75 125 H35 V175 H75" stroke="white" stroke-width="15" fill="none" />
      <rect x="100" y="100" width="100" height="100" fill="#8C8C8C" rx="20" ry="20"/>
      <circle cx="150" cy="125" r="8" fill="white" />
      <circle cx="150" cy="150" r="8" fill="white" />
      <circle cx="150" cy="175" r="8" fill="white" />
    </svg>
  </template>

  <script>
    // 로고 캐시버스팅/폴백
    (function(){
      const img = document.getElementById('brandLogo');
      function inlineFallback(){
        const tpl = document.getElementById('inlineLogo');
        if(!tpl) return;
        const svg = tpl.content.cloneNode(true);
        img.parentElement.replaceChild(svg, img);
      }
      img.addEventListener('error', inlineFallback);
      try { img.src = './gdc_logo.png?v=' + Date.now(); } catch(e){}
    })();

    // 이미 로그인되어 있으면 역할별로 바로 이동
    (function(){
      try{
        const raw = localStorage.getItem('gdc_user');
        if(!raw) return;
        const user = JSON.parse(raw);
        if (user?.role === 'admin') location.replace('admin.html');
        else if (user?.role) location.replace('staff.html');
      }catch(e){}
    })();

    // 엔드포인트 자동 선택: /api/login 우선, 실패 시 Functions 쿼리로 재시도
    async function loginRequest(body){
      // 1차: 프록시(/api/login) 사용 시
      try{
        const r1 = await fetch('/api/login', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if (r1.ok) return r1.json();
      }catch(_) {}

      // 2차: Netlify Functions 직접 호출 (route=login 가정)
      const u = new URL('/.netlify/functions/api', location.origin);
      u.searchParams.set('route','login');
      const r2 = await fetch(u, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      return r2.json();
    }

    // 로그인 submit 핸들러
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('loginForm');
      const btn  = document.getElementById('loginBtn');
      const err  = document.getElementById('err');
      if(!form) return;

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        err.textContent = '';
        btn.disabled = true;

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        try{
          const j = await loginRequest({ email, password });

          if (!j || !j.ok) {
            err.textContent = (j?.error === 'invalid_credentials')
              ? '아이디 또는 비밀번호가 올바르지 않습니다.'
              : (j?.error === 'email_and_password_required')
                ? '이메일/비밀번호를 입력해주세요.'
                : '로그인 실패: ' + (j?.error || 'unknown_error');
            btn.disabled = false;
            return;
          }

          // 성공: 사용자 정보 저장(비번 제거된 오브젝트)
          localStorage.setItem('gdc_user', JSON.stringify(j.user));

          // 역할별 이동
          if (j.user.role === 'admin') location.replace('admin.html');
          else location.replace('staff.html');

        }catch(ex){
          console.error(ex);
          err.textContent = '서버 통신 오류가 발생했습니다.';
          btn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
